<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager - Admin</title>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10000;
      max-width: 300px;
    }
    
    #cms-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      color: #666;
      background: #f8f9fa;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-log {
      margin-top: 20px;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      width: 300px;
    }
  </style>
</head>
<body>
  <!-- Debug info -->
  <div id="debug-info">
    <div><strong>CMS Debug Info:</strong></div>
    <div id="debug-content">Initializing...</div>
  </div>
  
  <!-- Loading indicator -->
  <div id="cms-loading">
    <div class="loading-spinner"></div>
    <p>Loading Content Management System...</p>
    <div class="status-log" id="status-log"></div>
    <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Reload
    </button>
  </div>
  
  <!-- Include Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  
  <script>
    // Debug logging function
    function logStatus(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const statusLog = document.getElementById('status-log');
      const debugContent = document.getElementById('debug-content');
      
      const logEntry = `[${timestamp}] ${message}`;
      console.log(logEntry);
      
      if (statusLog) {
        statusLog.innerHTML += `<div style="color: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#333'}">${logEntry}</div>`;
        statusLog.scrollTop = statusLog.scrollHeight;
      }
      
      if (debugContent) {
        debugContent.innerHTML = `Status: ${message}`;
      }
    }
    
    // Hide loading indicator when CMS loads
    function hideLoader() {
      const loader = document.getElementById('cms-loading');
      if (loader) {
        loader.style.display = 'none';
      }
    }
    
    // Show error with detailed information
    function showError(message) {
      logStatus(`ERROR: ${message}`, 'error');
      const loader = document.getElementById('cms-loading');
      if (loader) {
        const spinner = loader.querySelector('.loading-spinner');
        if (spinner) {
          spinner.style.display = 'none';
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.innerHTML = `
          <div style="color: #e74c3c; text-align: center; margin-top: 20px;">
            <h3>⚠️ CMS Loading Error</h3>
            <p>${message}</p>
            <p style="font-size: 12px;">Check the debug log above for details.</p>
          </div>
        `;
        loader.appendChild(errorDiv);
      }
    }
    
    // Initialize when everything is ready
    function initializeAdmin() {
      try {
        logStatus('Starting admin initialization...');
        
        // Check required DOM elements
        const loader = document.getElementById('cms-loading');
        const debugInfo = document.getElementById('debug-info');
        
        if (!loader || !debugInfo) {
          showError('Required DOM elements missing');
          return;
        }
        
        logStatus('DOM elements found, checking scripts...');
        
        // Check if scripts loaded
        logStatus(`Netlify Identity: ${typeof window.netlifyIdentity !== 'undefined' ? 'Loaded' : 'Missing'}`);
        logStatus(`CMS Script: ${typeof window.CMS !== 'undefined' ? 'Loaded' : 'Missing'}`);
        
        // Initialize Netlify Identity first
        if (window.netlifyIdentity) {
          logStatus('Initializing Netlify Identity...');
          
          window.netlifyIdentity.on("init", user => {
            logStatus(`Identity initialized, user: ${user ? 'logged in' : 'not logged in'}`);
            
            if (!user) {
              window.netlifyIdentity.on("login", () => {
                logStatus('User logged in, redirecting...');
                document.location.href = "/admin/";
              });
            } else {
              logStatus('User already logged in');
            }
          });
          
          window.netlifyIdentity.on("error", err => {
            logStatus(`Identity error: ${err.message}`, 'error');
          });
          
          // Initialize identity
          window.netlifyIdentity.init();
        } else {
          logStatus('Netlify Identity not available, continuing without auth...', 'error');
        }
        
        // Wait for CMS to be available and initialize it
        function waitForCMS(attempts = 0) {
          logStatus(`Waiting for CMS (attempt ${attempts + 1}/100)...`);
          
          if (typeof CMS !== 'undefined') {
            try {
              logStatus('CMS loaded successfully, initializing...', 'success');
              
              // Don't hide loader yet - let CMS show its own interface
              
              // Initialize CMS without custom configurations first
              CMS.init();
              
              // Add custom configurations after init
              setTimeout(() => {
                try {
                  CMS.registerPreviewStyle('/css/normandpllc-styles.css');
                  logStatus('CMS preview styles registered', 'success');
                } catch (previewError) {
                  logStatus(`Preview style error: ${previewError.message}`, 'error');
                }
                
                // Hide loader after CMS is fully initialized
                hideLoader();
                logStatus('CMS fully initialized and ready!', 'success');
              }, 2000);
              
            } catch (error) {
              logStatus(`CMS initialization failed: ${error.message}`, 'error');
              showError('CMS initialization failed: ' + error.message);
            }
          } else if (attempts < 100) {
            // CMS not ready yet, try again in 100ms (max 10 seconds)
            setTimeout(() => waitForCMS(attempts + 1), 100);
          } else {
            logStatus('CMS failed to load after 10 seconds', 'error');
            showError('CMS failed to load after 10 seconds. Please check your internet connection and try again.');
          }
        }
        
        // Start waiting for CMS
        waitForCMS();
        
      } catch (error) {
        logStatus(`Admin initialization error: ${error.message}`, 'error');
        showError('Admin initialization failed: ' + error.message);
      }
    }
    
    // Start initialization when DOM is ready
    logStatus('Page loaded, waiting for DOM...');
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        logStatus('DOM loaded, starting initialization...');
        initializeAdmin();
      });
    } else {
      logStatus('DOM already loaded, starting initialization...');
      initializeAdmin();
    }
  </script>
</body>
</html>